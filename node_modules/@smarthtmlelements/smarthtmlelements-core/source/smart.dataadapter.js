
/* Smart HTML Elements v1.1.0 (2018-June) 
Copyright (c) 2011-2018 jQWidgets. 
License: https://htmlelements.com/license/ */

class DataAdapter{constructor(a){const b=Object.assign(this,a);if(b.$document=Smart.Utilities.Extend(document),b.boundSource=new Smart.ObservableArray,b.dataItemById=[],void 0===b.allowAdd&&(b.allowAdd=!0),void 0===b.allowRemove&&(b.allowRemove=!0),void 0===b.allowUpdate&&(b.allowUpdate=!0),a.dataSource||(a.dataSource=[]),!a.dataFields)b.dataFields=[];else if(a.dataSource&&0<a.dataSource.length){const b=Object.keys(a.dataSource[0]);for(let a=0;a<b.length;a++);}if(a.dataSourceType||(b.dataSourceType="array"),a.id||(b.id=null),b.dataFields){let a=[];for(let c=0;c<b.dataFields.length;c++){const d=b.dataFields[c],e=d.split(":"),f=e[0].trim(),g=1<e.length?e[1].trim():"string";a.push({name:f,dataType:g})}b.dataFields=a}a&&!1!==a.autoBind&&b.dataBind()}dataBind(){const a=this;a.clear(),"array"===a.dataSourceType&&a._bindToArray(),a._buildHierarchy()}refreshHierarchy(){const a=this;a._buildHierarchy()}find(){return that.boundSource.find(arguments)}toArray(){const a=this;return a.boundSource.toArray()}add(a){const b=this;if(!a)return;const c=b._getDataItem(a,b.boundSource.length);b[b.boundSource.length]=c,b.dataItemById[c.uid]=c;const d=b.boundSource.length,e=b.boundSource.push(c);return b.onChanged&&b.onChanged({type:"add",data:c}),b.refreshHierarchy(),e}removeLast(){const a=this,b=a.boundSource.pop();return a.onChanged&&a.onChanged({type:"removeLast",data:b}),a.refreshHierarchy(),b}remove(a){const b=this,c=b.boundSource[a];if(!c)throw new Error("Invalid Item Index");b.boundSource.splice(a,1),b.onChanged&&b.onChanged({type:"remove",index:a,data:result}),b.refreshHierarchy()}insert(a,b){const c=this,d=c.boundSource.splice(a,0,b);return c.onChanged&&c.onChanged({type:"insert",index:a,data:b}),c.refreshHierarchy(),d}indexOf(a){const b=this,c=b.boundSource.indexOf(a);return c}get length(){const a=this;return a.boundSource.length}indexOf(a){const b=this;return b.boundSource.indexOf(a)}clear(){const a=this;for(let b=0;b<a.boundSource.length;b++)delete a[b];a.boundSource=new Smart.ObservableArray,a.dataItemById=[],a.refreshHierarchy()}_getId(a,b,c){if(null!=a&&a.name!=null&&a.name){var e=b.getAttribute(a.name);if(null!=e&&0<e.toString().length)return e;if(a.map)try{var e=b.getAttribute(a.map);if(null!=e&&0<e.toString().length)return e}catch(a){return c}return}if(a&&0<a.toString().length){var e=$(b).attr(a);if(null!=e&&0<e.toString().length)return $.trim(e).split(" ").join("").replace(/([ #;?%&,.+*~\':'!^$[\]()=>|\/@])/g,"");var f=a.split(this.mapChar);if(1<f.length){for(var g=b,h=0;h<f.length;h++)null!=g&&(g=g[f[h]]);if(null!=g)return g}else if(null!=b[a])return b[a]}return c}_buildHierarchy(){const a=this;if(!a.reservedNames)a.reservedNames={leaf:"leaf",parent:"parent",expanded:"expanded",checked:"checked",selected:"selected",level:"level",icon:"icon",data:"data"};else{const b=a.reservedNames;b.leaf||(b.leaf="leaf"),b.parent||(b.parent="parent"),b.expanded||(b.expanded="expanded"),b.checked||(b.checked="checked"),b.selected||(b.selected="selected"),b.level||(b.level="level"),b.data||(b.data="data")}const b=a.reservedNames;if(a.childrenDataField){for(let c=0;c<this.boundSource.length;c++){const d=this.boundSource[c];if(!d)continue;const e=function(c){if(a.item)c.boundSource=c[a.childrenDataField][a.item];else{const b=a.childrenDataField.split(a.mapChar);let e=null;if(1<b.length){let a=c;for(let c=0;c<b.length;c++)null!=a&&(a=a[b[c]]);e=a}else e=c[a.childrenDataField];c.boundSource=e}(null===c.boundSource||c.boundSource&&0===c.boundSource.length)&&(c[b.leaf]=!0)};e(d),d[b.level]=0;let f=this._getId(a.id,d,c);d.uid=f,d[b.parent]=null,d[b.data]=d,d[b.expanded]===void 0&&(d[b.expanded]=!1);const g=function(c,d){if(!d)return void(c.boundSource=[]);for(let f,h=0;h<d.length;h++){if(f=d[h],!f)continue;e(f),f[b.level]=c[b.level]+1,f[b.parent]=c,f[b.data]=f;let i=a._getId(a.id,f,h);f.uid=i==h&&null==a.id?c.uid+"_"+i:i,void 0===f[b.expanded]&&(f[b.expanded]=!1),g(f,f.boundSource)}};g(d,d.boundSource)}this.itemHierarchy=hierarchy}a.xmlRoot&&"xml"==a.dataSourceType&&(this.itemHierarchy=this._getDataItemHierarchy("uid","_parentuid","boundSource",null,a.boundSource)),a.keyDataField&&a.parentDataField&&(this.itemHierarchy=this._getDataItemHierarchy(a.keyDataField.name,a.parentDataField.name,"boundSource",null,a.boundSource)),a.groupBy&&(this.itemHierarchy=this._getGroupDataItemHierarchy(a.groupBy,"boundSource","label",null,"data",null,"parent",a.boundSource))}_getGroupDataItemHierarchy(a,b,c,d,e,f,g,h,i){let j=this;i||(i=0);let k=j.reservedNames;const l=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()};let m=[];for(let j=0;j<a.length;j++)m[j]=l();b||(b="items"),c||(c="group"),e||(e="item"),g||(g="parent"),void 0===f&&(f="value");const n=[],o=[];let p=0;if(!h){this.boundSource}const q=function(a){let b=a;return d&&$.each(d,function(){this.name&&this.map&&(b[this.map]=b[this.name])}),b};for(let j,r=0;r<h.length;r++){j=Object.assign({},q(h[r])),j[k.leaf]=!1;j.uid;let d=[],s=0;for(let b=0;b<a.length;b++){const c=a[b],e=j[c];null!=e&&(d[s++]={value:e,group:c,hash:m[b]})}if(d.length!==a.length)break;let t=null,u="",v=-1;for(let a=0;a<d.length;a++){const h=d[a].value,l=d[a].group,m=d[a].hash;if(v++,u=u+"_"+m+"_"+h,null!=o[u]&&null!=o[u]){t=o[u];continue}if(null===t){t={},t[k.level]=0,t[k.leaf]=!1,t[g]=null,t[c]=h,t[e]=j,t.groupDataField=l,t[k.expanded]=void 0!==j[k.expanded]&&j[k.expanded],f&&(t[f]=j[f]),t[b]=[];let a=n.length+i;(!this.id||"number"==typeof j.uid||isFinite(j.uid))&&(a="Item"+a),void 0===t.uid&&(t.uid=a),n[p++]=t}else{const a={};a[k.level]=t[k.level]+1,a[g]=t,a[c]=h,a[b]=[],a[e]=j,a.groupDataField=l,a[k.leaf]=!1,a[k.expanded]=void 0!==j[k.expanded]&&j[k.expanded],f&&(a[f]=j[f]),void 0===a.uid&&(a.uid=t.uid+"_"+t[b].length),t[b][t[b].length]=a,t=a}o[u]=t}j&&(j[k.leaf]=!0),null===t?void 0===j.uid&&(j.uid=l()):(null===this.id?void 0===j.uid&&(j.uid=t.uid+"_"+t[b].length):void 0===j.uid&&-1==j.uid.toString().indexOf(t.uid)&&(j.uid=t.uid+"_"+j.uid),j[g]=t,j[k.level]=t[k.level]+1,t[b][t[b].length]=j)}return n}_getDataItemHierarchy(a,b,c,d,e){let f=[],g=this.boundSource;if(e&&(g=e),0==this.boundSource.length)return null;let h=null==c?"items":c,j=[],k=g,l=k.length,m=that.reservedNames,i=function(a){let b=a;return d&&$.each(d,function(){this.name&&this.map&&(b[this.map]=b[this.name])}),b};for(let f=0;f<l;f++){let c=Object.assign({},k[f]),d=c[b],e=c[a];j[e]={parentId:d,item:c}}for(let g=0;g<l;g++){let c=Object.assign({},k[g]),d=c[b],e=c[a];if(null!=j[d]){let a={parentId:d,item:j[e].item},b=j[d].item;b[h]||(b[h]=[]);let c=b[h].length;a=a.item,m?null==a[m.parent]&&(a[m.parent]=b):null==a.parent&&(a.parent=b);let f=i(a);b[h][c]=f,j[d].item=b,j[e]=a}else{let a=j[e].item;m?null==a[m.parent]&&(a[m.parent]=null):null==a.parent&&(a.parent=null);let b=i(a);m?b[m.level]=0:b.level=0,f[f.length]=b}}if(0!=f.length){let a=function(b,c){for(let d=0;d<c.length;d++){m?c[d][m.level]=b:c[d].level=b;let e=c[d][h];e?0<e.length?a(b+1,e):m?c[d][m.leaf]=!0:c[d].leaf=!0:m?c[d][m.leaf]=!0:c[d].leaf=!0}};a(0,f)}return f}summarize(a,b){const c=this;Array.isArray(a)||(a=[a]);let d=[];for(let c=0;c<a.length;c++){const b=a[c];for(let a in b){const c=b[a];d.push({dataField:a,functions:c})}}a=d;let e={},f=[];b||(b=c.boundSource);let g=b.length;if(0!=g&&null!=g){for(let c,d=0;d<g;d++){c=b[d];for(let b=0;b<a.length;b++){const g=a[b];let h=c[g.dataField];if(g.functions){e[g.dataField]=e[g.dataField]||{},f[g.dataField]=f[g.dataField]||0,f[g.dataField]++;const a=function(a){for(name in a){let b=e[g.dataField][name];null==b&&(e[g.dataField][name]=0,b=0),"function"==typeof a[name]&&(b=a[name](b,h,g.dataField,c)),e[g.dataField][name]=b}};let b=parseFloat(h);b=!isNaN(b),b&&(h=parseFloat(h)),"number"==typeof h&&isFinite(h)?g.functions.forEach(function(b){let c=e[g.dataField][b];if(null==c&&(c=0,"min"==this&&(c=9999999999999),"max"==this&&(c=-9999999999999)),"sum"==b||"avg"==b||"stdev"==b||"stdevp"==b||"var"==b||"varp"==b)c+=parseFloat(h);else if("product"==b)0==d?c=parseFloat(h):c*=parseFloat(h);else if("min"==b)c=Math.min(c,parseFloat(h));else if("max"==b)c=Math.max(c,parseFloat(h));else if("count"==b)c++;else if("object"==typeof b)return void a(b);e[g.dataField][b]=c}):g.functions.forEach(function(b){if("min"==b||"max"==b||"count"==b||"product"==b||"sum"==b||"avg"==b||"stdev"==b||"stdevp"==b||"var"==b||"varp"==b){if(null===h)return!0;let a=e[g.dataField][b];return null==a&&(a=0),e[g.dataField][b]=a,!0}"object"==typeof b&&a(b)})}}}for(let c=0;c<a.length;c++){const d=a[c];if(d.functions){if(e[d.dataField]||(e[d.dataField]={},d.functions.forEach(function(a){e[d.dataField][a]=0})),void 0!==e[d.dataField].avg){const a=e[d.dataField].avg,b=f[d.dataField];e[d.dataField].avg=0===b||null==b?0:a/b}else null!=e[d.dataField].count&&(e[d.dataField].count=g);(e[d.dataField].stdev||e[d.dataField].stdevp||e[d.dataField]["var"]||e[d.dataField].varp)&&d.functions.forEach(function(a){if("stdev"==a||"var"==a||"varp"==a||"stdevp"==a){const c=e[d.dataField][a],f=g,h=c/g;let j=0;for(let a=0;a<g;a++){let c=b[a],e=c[d.dataField];j+=(e-h)*(e-h)}let i="stdevp"==a||"varp"==a?f:f-1;0==i&&(i=1),"var"==a||"varp"==a?e[d.dataField][a]=j/i:("stdevp"==a||"stdev"==a)&&(e[d.dataField][a]=Math.sqrt(j/i))}})}}return e}}_getDataItem(a,b){const c=this,d=Object.assign(a,{}),e={};for(let f=0;f<c.dataFields.length;f++){const b=c.dataFields?c.dataFields[f]:{};let g="";if(null==b||null==b)continue;if(b.map){let a=b.map.split(me.mapChar);if(0<a.length){let b=d;for(let c=0;c<a.length;c++)d&&(b=b[a[c]]);g=b}else g=d[datafield.map]}void 0!==g&&null!==g?g=g.toString():void 0===g&&null!==g&&(g="");let h=!1;""===g&&(h=!0,g=a[b.name],void 0!==g&&null!==g?"array"!==b.dataType&&("date"===b.dataType?g&&g instanceof Date&&(g=g):g=g.toString()):g=""),"[object Object]"==g&&b.map&&h&&(g=""),g=c.$document.deserialize(""+g,b.dataType,!0),"string"!==b.dataType&&"boolean"!==b.dataType&&"bool"!==b.dataType&&(isNaN(g)||g===-Infinity||g===1/0)&&(g=0),e[b.name]=g}let f=b;return c.id&&(f=d[c.id],"object"==typeof f&&(f=b)),e.uid=f,e.boundIndex=b,Object(e)}_bindToArray(){const a=this;for(let b=0;b<a.dataSource.length;b++){const c=a.dataSource[b],d=a._getDataItem(c,b);a.boundSource.push(d),a[b]=a.boundSource[a.boundSource.length-1],a.dataItemById[d.uid]=a[b]}}sort(a,c,b,d,e){const f=this;let g=!1;if(a&&a.constructor&&"ObservableArray"===a.constructor.name&&(g=!0),(!a||!(a instanceof Array)||0===a.length||!c||c instanceof Array&&0===c.length)&&!g)throw new Error("sort: Missing or Invalid arguments!");"string"==typeof c&&(c=[c]);const h=[],j=[];void 0===b&&(b=[]);const k=function(b,a){let c;switch(a||typeof b){case"string":c=new Intl.Collator().compare;break;case"number":c=function(c,a){return c-a};break;case"boolean":c=function(c,a){return c===a?0:!1===c?-1:1};break;case"object":if(b instanceof Date)c=function(c,a){return c.getTime()-a.getTime()};else if(b instanceof Smart.Utilities.DateTime||b instanceof BigNumberNG)c=function(c,a){return c.compare(a)};else if(b instanceof Smart.Utilities.Complex||window.NIComplex&&b instanceof window.NIComplex){const d=new Smart.Utilities.ComplexNumericProcessor;c=function(c,a){return d.compareComplexNumbers(c,a)}}}return c};for(let f=0;f<c.length;f++){h[f]=void 0===b[f]||"asc"===b[f]||"ascending"===b[f]?1:-1;const e=a[0][c[f]];j[f]=k(e,d[f])}if(e)return void e(a,c,b,j);a.sort(function(d,a){for(let b=0;b<c.length;b++){const e=j[b](d[c[b]],a[c[b]]);if(0===e){if(c[b+1])continue;else if(void 0!==d._index)return(d._index-a._index)*h[b];return 0}return e*h[b]}if(0===c.length)return d.boundIndex<a.boundIndex?-1:d.boundIndex>a.boundIndex?1:0});for(let g=0;g<a.length;g++)f[g]=a[g]}}Smart.DataAdapter=DataAdapter;