
/* Smart HTML Elements v1.1.0 (2018-June) 
Copyright (c) 2011-2018 jQWidgets. 
License: https://htmlelements.com/license/ */

Smart("smart-filter-builder",class extends Smart.BaseElement{static get properties(){return{customOperations:{value:[],type:"array",reflectToAttribute:!1},fields:{value:null,type:"array?",reflectToAttribute:!1},hint:{value:null,type:"string?"},messages:{value:{en:{addCondition:"Add Condition",addGroup:"Add Group",and:"And",notand:"Not And",or:"Or",notor:"Not Or","=":"Equals","<>":"Does not equal",">":"Greater than",">=":"Greater than or equal to","<":"Less than","<=":"Less than or equal to",between:"Between",startswith:"Starts with",endswith:"Ends with",contains:"Contains",notcontains:"Does not contain",isblank:"Is blank",isnotblank:"Is not blank"}},type:"object",extend:!0},placeholder:{value:"&lt;enter a value&gt;",type:"string"},value:{value:null,type:"array?",reflectToAttribute:!1},valueFormatFunction:{value:null,type:"function?",reflectToAttribute:!1}}}static get requires(){return{"Smart.Button":"smart.button.js","Smart.ToggleButton":"smart.togglebutton.js","Smart.ScrollBar":"smart.scrollbar.js","Smart.ListBox":"smart.listbox.js","Smart.DropDownList":"smart.dropdownlist.js","Smart.ComboBox":"smart.combobox.js","Smart.TextBox":"smart.textbox.js","Smart.Utilities.Complex":"smart.complex.js","Smart.Utilities.BigNumber":"smart.math.js","Smart.Utilities.NumericProcessor":"smart.numeric.js","Smart.NumericTextBox":"smart.numerictextbox.js","Smart.Menu":"smart.menu.js"}}static get listeners(){return{click:"_clickHandler","conditionsMenu.itemClick":"_menuItemClickHandler","conditionsMenu.open":"_menuOpenCloseScrollHandler","conditionsMenu.close":"_menuOpenCloseScrollHandler","container.wheel":"_mouseWheelHandler","horizontalScrollBar.change":"_horizontalScrollbarHandler","verticalScrollBar.change":"_verticalScrollbarHandler",resize:"_handleScrollbarsDisplay","textBoxEditor.change":"_editorsChangeHandler","numericTextBoxEditor.change":"_editorsChangeHandler","dropDownListEditor.change":"_editorsChangeHandler"}}template(){return`<div id="container" title="[[hint]]">
                <div id="innerContainer" class ="smart-inner-container">
                    <div id="contentContainer" class ="smart-content-container"></div>
                    <div id="editorsContainer" class ="smart-editors-container">
                        <smart-text-box id="textBoxEditor" class ="smart-text-box-editor smart-hidden"></smart-text-box>
                        <smart-numeric-text-box id="numericTextBoxEditor" spin-buttons class ="smart-numeric-text-box-editor smart-hidden"></smart-numeric-text-box>
                        <smart-drop-down-list id="dropDownListEditor" class ="smart-drop-down-list-editor smart-hidden"></smart-drop-down-list>
                    </div>
                    <smart-menu id="conditionsMenu" mode="dropDown" class ="smart-conditions-menu"></smart-menu>
                </div>
                <smart-scroll-bar id="verticalScrollBar" class="smart-vertical-scroll-bar" disabled="[[disabled]]" orientation="vertical"></smart-scroll-bar>
                <smart-scroll-bar id="horizontalScrollBar" class="smart-horizontal-scroll-bar" disabled="[[disabled]]" ></smart-scroll-bar>
            </div>`}propertyChangedHandler(a,b,c){const d=this;switch(super.propertyChangedHandler(a,b,c),a){case"fields":d._mapFields();break;case"localization":break;case"placeholder":d._updatePlaceholder();break;case"value":d._emptyInnerStructure(),d._convertValueToFlat(c),d._generateHTMLStructureFromFlatValue();}}ready(){super.ready();const a=this;a._setInitialValues(),a._emptyInnerStructure(),a._convertValueToFlat(a.value),a._generateHTMLStructureFromFlatValue(),a._scrollView=new Smart.Utilities.Scroll(a.$.innerContainer,a.$.horizontalScrollBar,a.$.verticalScrollBar),a._scrollView.horizontalScrollBar.$.addClass("smart-hidden"),a._scrollView.verticalScrollBar.$.addClass("smart-hidden"),a._handleScrollbarsDisplay()}toString(){const a=this;let b=a.value.slice();return JSON.stringify(b)}_convertValueToFlat(a,b){const c=this,d=/^(and|or|notAnd|notOr)$/i;if(!a)return;const e=a.filter(a=>"string"==typeof a&&a.match(d)),f=e?e[0]:null,g=a.filter(a=>Array.isArray(a)&&3===a.length&&0===a.filter(a=>"string"==typeof a&&a.match(d)).length),h=a.filter(a=>!g.includes(a)&&a!==f);if(e){const a=c._lastProcessedItemInCurrentGroup.parentId?".":"",d=(c._lastProcessedItemInCurrentGroup.parentId||"")+a+(b||0),e={nodeId:d,parentId:c._lastProcessedItemInCurrentGroup.parentId,type:"group",data:f,htmlNode:null};c._valueFlat.push(e),c._lastProcessedItemInCurrentGroup.position=0;for(let a=0;a<g.length;a++){const b=d+"."+(c._lastProcessedItemInCurrentGroup.position||0),e={nodeId:b,parentId:d,type:"condition",data:g[a],htmlNode:null};c._valueFlat.push(e),c._lastProcessedItemInCurrentGroup.position++}for(let a=0;a<h.length;a++)c._lastProcessedItemInCurrentGroup.parentId=d,c._convertValueToFlat(h[a],g.length+a),c._lastProcessedItemInCurrentGroup.position++}}_emptyInnerStructure(){const a=this;a.$.contentContainer.innerHTML="",a._valueFlat=[],a._lastProcessedItemInCurrentGroup={parentId:null,id:null,position:null}}_generateHTMLStructureFromFlatValue(){const a=this,b=document.createDocumentFragment();if(a._valueFlat&&0!==a._valueFlat.length)for(let c=0;c<a._valueFlat.length;c++){const d=a._valueFlat[c],e=d.parentId?document.querySelector("[node-id=\""+d.parentId+"\"]").querySelector(".smart-filter-group-condition-container"):a.$.contentContainer;if("group"===d.type){const e=document.createElement("div"),f=a._filterGroupRow(d.data),g=document.createElement("div");e.className="smart-filter-group",g.className="smart-filter-group-condition-container",e.appendChild(f),e.appendChild(g),b.appendChild(e),e.setAttribute("node-id",d.nodeId),a._valueFlat[c].htmlNode=e}else{const e=a._filterConditionRow(d.data);e.setAttribute("node-id",d.nodeId),b.appendChild(e),a._valueFlat[c].htmlNode=e}e.appendChild(b)}}_addOperatorToFilterGroup(a,b){const c=this;if(!a)return;const d=a.split(".");let e=c.value;b=b||"and";for(let c=0;c<d.length;c++){const b=0<a.length&&"string"==typeof e[d[c]]?parseInt(d[c])+1:parseInt(d[c]);e=e[b]}e.splice(1,0,b)}_clearConditionsValue(a){const b=this,c=b.querySelector("[node-id=\""+(a||0)+"\"]"),d=c.querySelector(".smart-filter-value");for(let c=0;c<b._valueFlat.length;c++)b._valueFlat[c].nodeId===a&&(b._valueFlat[c].data[2]=null);d.innerHTML=b.placeholder,d.value=null,d.closest(".smart-filter-group-condition").value=null}_clickHandler(a){const b=this,c=a.target,d=c?c.closest(".smart-filter-group-condition"):null,e=d?d.getAttribute("node-id"):null,f=c?c.closest(".smart-filter-group"):null,g=f?f.getAttribute("node-id"):null,h=c.closest(".smart-filter-add-btn"),i=c.closest(".smart-filter-delete-btn"),j=c.closest(".filter-builder-item");if(!b.disabled){if(i){const a=c.closest(".smart-filter-group-operator");if(b._closeEditor(),b.$.conditionsMenu.close(),a)return b._deleteElement(f,"group"),f.parentElement.removeChild(f),void b._generateValue();const d=c.closest(".smart-filter-group-condition");if(d)return b._deleteElement(d),d.parentElement.removeChild(d),void b._generateValue()}if(h)return b._closeEditor(),b._contextMenuOptions=b._addOptions,void b._handleContextMenu(c);if(j){const a=j.classList;if(b._editedItemData={id:e||g,isConditionRow:!!g&&!!e,isFieldName:!!c.closest(".smart-filter-field-name"),value:c.innerHTML,fieldData:b._fields.filter(a=>a.value===c.innerHTML||a.label===c.innerHTML)},a.contains("smart-filter-group-operation"))b._contextMenuOptions=b._groupOperationDescriptions;else if(a.contains("smart-filter-field-name"))b._contextMenuOptions=b._fields;else if(a.contains("smart-filter-operation"))b._contextMenuOptions=b._filterOperationDescriptions;else return void b._openEditor(c);return void b._handleContextMenu(c)}b.$.conditionsMenu.close(),!b._editor||c.closest(b._editor.tagName)||b._closeEditor()}}_editorsChangeHandler(){const a=this;a._closeEditor()}_closeEditor(a){const b=this;if(b._editedItem&&b._editorIsOpen){const c=b._editedItem.closest(".smart-filter-group-condition"),d=c.getAttribute("node-id");b._updateValueInFlatArray(d,b._editor.value,"value","string"),b._generateValue(a),b._editedItem.removeAttribute("edited"),b._editedItem.innerHTML=b._editor.value||b.placeholder,b._editor.classList.add("smart-hidden"),c.value=b._editor.value,b._editorIsOpen=!1}}_deleteElement(a,b){function c(a){const b=e._valueFlat.filter(b=>a===b.nodeId),c=b?b[0]:null;e._valueFlat.splice(e._valueFlat.indexOf(c),1),e._handleScrollbarsDisplay()}function d(a){const b=e._valueFlat.filter(b=>a===b.nodeId),f=b?b[0]:null;for(let b=0;b<e._valueFlat.length;b++){const f=e._valueFlat[b],g=f.nodeId;f.parentId===a&&("group"===f.type?d(g):c(g),e._valueFlat.splice(e._valueFlat.indexOf(f),1))}e._valueFlat.splice(e._valueFlat.indexOf(f),1),e._handleScrollbarsDisplay()}const e=this,f=a.getAttribute("node-id");"group"===b?d(f):c(f),e._generateValue()}_filterConditionRow(a){const b=this;a=a||[];const c=a[0]||"please select",d=b.localize(a[1]),e=a[2]||"please enter value";let f=document.createElement("div");return f.className="smart-filter-group-condition",f.innerHTML=`<span class ="smart-filter-delete-btn"></span>
                <span class ="filter-builder-item smart-filter-field-name">${c}</span>
                <span class ="filter-builder-item smart-filter-operation">${d}</span>
                <span class ="filter-builder-item smart-filter-value">${e}</span>`,f}_filterGroupRow(a){const b=this;a=b.localize(a||"and");let c=document.createElement("div"),d=`<span class ="smart-filter-delete-btn"></span>
                <span class ="filter-builder-item smart-filter-group-operation">${a}</span>
                <span class ="smart-filter-add-btn"></span>`;return c.className="smart-filter-group-operator",c.innerHTML=d,c}_generateValue(){function a(a){for(let b=0;b<a.length;b++){const d=a[b];let e={};"group"===d.type&&(e.nodeId=d.nodeId,e.parentId=d.parentId,e.structure=[d.data],c.push(e))}for(let b=0;b<c.length;b++){const d=c[b],e=a.filter(a=>a.parentId===d.nodeId&&"condition"===a.type);for(let a=0;a<e.length;a++)0==a?d.structure.unshift(e[a].data):d.structure.push(e[a].data)}c=c.filter(a=>1<a.structure.length),c.sort(function(c,a){const b=c.nodeId.split(".").length,d=a.nodeId.split(".").length;return b<d});for(let b=0;b<c.length;b++){const a=c[b],d=c.filter(b=>b.nodeId===a.parentId)[0];d&&d.structure&&d.structure.push(a.structure)}}const b=this;let c=[],d=b._valueFlat.slice();a(d),b.value=c[c.length-1].structure}_handleContextMenu(a){const b=this;if(b._selectedElement===a&&b.$.conditionsMenu.opened)return;const c=a.getBoundingClientRect(),d=b.getBoundingClientRect(),e=c.left+b.$.contentContainer.scrollLeft-d.left,f=c.top+b.$.contentContainer.scrollTop-d.top+30;b.$.conditionsMenu.close(),b._closeEditor(),b.$.conditionsMenu.dataSource=b._contextMenuOptions,b.$.conditionsMenu.open(e,f),b._selectedElement=a}_handleScrollbarsDisplay(){const a=this,b=a.$.innerContainer;setTimeout(function(){b.scrollWidth>b.clientWidth?(a.$container.addClass("hscroll"),a._scrollView.scrollWidth=b.scrollWidth-b.clientWidth):a.$container.removeClass("hscroll"),b.scrollHeight>b.clientHeight?(a.$container.addClass("vscroll"),a._scrollView.scrollHeight=b.scrollHeight-b.clientHeight):a.$container.removeClass("vscroll")},0)}_horizontalScrollbarHandler(a){const b=this;b.disabled||(a.stopPropagation(),b.$.innerContainer.scrollLeft=a.detail.value)}_mapFields(){const a=this;a.fields&&(a._fields=a.fields.map(a=>{let b={label:a.label,value:a.dataField};return b}))}_menuItemClickHandler(a){var b=Math.max;const c=this,d=c._selectedElement.closest(".filter-builder-item"),e=a.detail,f=e.value,g=e.label;if(d){const a=d.closest(".smart-filter-group-condition")?d.closest(".smart-filter-group-condition").getAttribute("node-id"):d.closest(".smart-filter-group").getAttribute("node-id");let b=2;if(d.innerHTML=g,d.value=f,c._editedItemData&&c._editedItemData.isFieldName&&c._editedItemData.value!==f&&c._clearConditionsValue(c._editedItemData.id),d.classList.contains("smart-filter-field-name"))b=0;else if(d.classList.contains("smart-filter-operation"))b=1;else if(d.classList.contains("smart-filter-group-operation")){for(let b=0;b<c._valueFlat.length;b++)c._valueFlat[b].nodeId===a&&(c._valueFlat[b].data=d.value);return void c._generateValue()}for(let e=0;e<c._valueFlat.length;e++)c._valueFlat[e].nodeId===a&&(c._valueFlat[e].data[b]=d.value);return void c._generateValue()}const h=c._selectedElement.closest(".smart-filter-group"),i=h.querySelector(".smart-filter-group-condition-container"),j=i.querySelector(".smart-filter-group");if("addCondition"===f){const a=c.fields[0].label||c.fields[0].value,d=c._filterConditionRow([a,"=",null]);i.insertBefore(d,j),d.value=null;const e=Array.from(h.querySelectorAll("[node-id]")),f=e.map(a=>{const b=a.getAttribute("node-id"),c=b.split(".");return a.closest(".smart-filter-group")!==h&&a.closest(".smart-filter-group")!==a?0:parseInt(c[c.length-1])}),g=0<f.length?b(...f):-1,k=g+1,l=h.getAttribute("node-id"),m=l?l+"."+k:k;d.nodeId=m,d.setAttribute("node-id",m);const n={nodeId:m,parentId:l,type:"condition",data:[c.fields[0].dataField,"=",null],dataType:c.fields?c.fields[0].dataType:"string",htmlNode:d};c._valueFlat.push(n)}else if("addGroup"===f){const a=document.createElement("div"),d=c._filterGroupRow("and"),e=Array.from(h.querySelectorAll("[node-id]")),f=e.map(a=>{const b=a.getAttribute("node-id"),c=b.split(".");return a.closest(".smart-filter-group")!==h&&a.closest(".smart-filter-group")!==a?0:parseInt(c[c.length-1])}),g=0<f.length?b(...f):-1,j=g+1,k=h.getAttribute("node-id"),l=k?k+"."+j:j,m=document.createElement("div");a.className="smart-filter-group",m.className="smart-filter-group-condition-container",a.appendChild(d),a.appendChild(m),i.appendChild(a);c._valueFlat.push({nodeId:l,parentId:k,type:"group",data:"and",htmlNode:a}),a.setAttribute("node-id",l)}c._generateValue(),c._handleScrollbarsDisplay()}_menuOpenCloseScrollHandler(a){const b=this,c=a.type;return"open"===c?(b._scrollTop=b.scrollTop,void(b._scrollLeft=b.scrollLeft)):void(b.scrollTop=b._scrollTop||0,b.scrollLeft=b._scrollLeft||0)}_mouseWheelHandler(a){const b=this;b._scrollView.hScrollBar.$.hasClass("smart-hidden")&&b._scrollView.vScrollBar.$.hasClass("smart-hidden")||!b.disabled&&!b._scrollView.vScrollBar.$.hasClass("smart-hidden")&&(a.stopPropagation(),a.preventDefault(),b._scrollView.scrollTo(b._scrollView.scrollTop+(0>a.deltaY?-b.offsetHeight:b.offsetHeight)))}_openEditor(a){const b=this,c=b.getBoundingClientRect(),d=a.getBoundingClientRect(),e=d.left+b.$.contentContainer.scrollLeft-c.left,f=d.top+b.$.contentContainer.scrollTop-c.top,g=a&&a.closest(".smart-filter-group-condition")&&a.closest(".smart-filter-group-condition").value?a.closest(".smart-filter-group-condition").value:"";b._editedItem&&b._editedItem!==a.closest(".filter-builder-item")&&b._closeEditor(),b.$.conditionsMenu.close(),a.setAttribute("edited",""),b._editedItem=a.closest(".filter-builder-item");const h=typeof b._editedItem.innerHTML;"number"==h?(b._editor=b.$.numericTextBoxEditor,b._editor.value=g):"array"==h?(b._editor=b.$.dropDownListEditor,b._editor.value=g):(b._editor=b.$.textBoxEditor,b._editor.value=g+"");setTimeout(function(){b._editor.$.input.focus(),b._editor.$.input.selectionStart=b._editor.$.input.selectionEnd=b._editor.$.input.value.length},0),b.$.editorsContainer.style.left=e+"px",b.$.editorsContainer.style.top=f+"px",b._editor.classList.remove("smart-hidden"),b._editorIsOpen=!0}_setInitialValues(){const a=this;a._mapFields(),a._addOptions=[{label:a.localize("addCondition"),value:"addCondition"},{label:a.localize("addGroup"),value:"addGroup"}],a._groupOperationDescriptions=[{label:a.localize("and"),value:"and"},{label:a.localize("notand"),value:"notand"},{label:a.localize("or"),value:"or"},{label:a.localize("notor"),value:"notor"}],a._filterOperationDescriptions=[{label:a.localize("="),value:"="},{label:a.localize("<>"),value:"<>"},{label:a.localize(">"),value:">"},{label:a.localize(">="),value:">="},{label:a.localize("<"),value:"<"},{label:a.localize("<="),value:"<="},{label:a.localize("between"),value:"between"},{label:a.localize("startswith"),value:"startswith"},{label:a.localize("endswith"),value:"endswith"},{label:a.localize("contains"),value:"contains"},{label:a.localize("notcontains"),value:"notcontains"},{label:a.localize("isblank"),value:"isblank"},{label:a.localize("isnotblank"),value:"isnotblank"}],a.$.conditionsMenu.dropDownAppendTo=a.$.container,a.$.conditionsMenu.dataSource=a._groupOperationDescriptions,a._valueFlat=[],a._lastProcessedItemInCurrentGroup={parentId:null,id:null,position:null}}_updatePlaceholder(){const a=this;for(let b=0;b<a._valueFlat.length;b++){const c=a._valueFlat[b];"condition"===c.type&&(null===c.data[2]||""===c.data[2])&&(c.htmlNode.querySelector(".smart-filter-value").innerHTML=a.placeholder)}}_updateValueInFlatArray(a,b,c,d){const e=this;if(a&&b&&!e.disabled){d=d||"string",c=c||"value","number"===d?b=parseFloat(b):"boolean"===d?b=!!b:"string"===d?b+="":void 0;for(let d=0;d<e._valueFlat.length;d++)e._valueFlat[d].nodeId===a&&("column"===c?e._valueFlat[d].data[0]=b:"filterCondition"===c?e._valueFlat[d].data[1]=b:"value"===c?e._valueFlat[d].data[2]=b:"groupCondition"===c?e._valueFlat[d].data=b:void 0)}}_verticalScrollbarHandler(a){const b=this;b.disabled||(a.stopPropagation(),b.$.innerContainer.scrollTop=a.detail.value)}});